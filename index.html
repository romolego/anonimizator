<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Псевдоанонимизация Excel-таблиц v0.1</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Псевдоанонимизация Excel-таблиц</h1>
        
        <!-- Инструкция -->
        <div class="section collapsible" id="instructionSection">
            <div class="collapsible-header">
                <h2>Инструкция</h2>
                <button class="collapse-toggle" onclick="toggleCollapse('instructionBody', this)">Развернуть</button>
            </div>
            <div class="collapsible-body" id="instructionBody" style="display: none;">
                <div class="collapsible-content">
                    <ul class="instruction-list">
                        <li>Загрузите XLSX, выберите лист и нажмите «Распознать данные».</li>
                        <li>Отметьте столбцы для токенизации, при необходимости переставьте маркер строки слева и нажмите «Токенизировать выбранные столбцы».</li>
                        <li>Меняйте режим отображения для проверки исходных значений и токенов.</li>
                        <li>Перед очисткой скачайте таблицу и JSON-словарь (или воспользуйтесь «Скачать комплект» в блоке экспорта).</li>
                        <li>Для детокенизации импортируйте JSON-словарь, вставьте ответ модели в «сырой» блок — результат появится ниже.</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Загрузка файла и управление -->
        <div class="section">
            <h2>Загрузка файла</h2>
            <div class="file-controls-row">
                <div class="file-control-item">
                    <label for="fileInput">Выбор файла XLSX:</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <div class="file-control-item" id="sheetSelectionWrapper" style="display: none;">
                    <label for="sheetSelect">Лист:</label>
                    <select id="sheetSelect"></select>
                </div>
                <div class="file-control-item">
                    <button id="recognizeButton" onclick="recognizeData()" style="display: none;">Распознать данные</button>
                </div>
                <div class="file-control-item file-control-item-clear">
                    <button id="clearButton" onclick="clearAll()" style="display: none;">Очистить</button>
                </div>
            </div>
        </div>

        <!-- Таблица -->
        <div class="section" id="tableSection" style="display: none;">
            <h2>Таблица</h2>
            <div class="table-controls-row">
                <div class="table-controls-left">
                    <button onclick="tokenizeColumns()">Токенизировать выбранные столбцы</button>
                </div>
                <div class="table-controls-right">
                    <div id="fontSizeWrapper" class="view-mode-wrapper">
                        <label for="fontSizeSelect">Размер текста в таблице:</label>
                        <select id="fontSizeSelect" onchange="updateTableFontSize()">
                            <option value="10px">10px</option>
                            <option value="12px" selected>12px</option>
                            <option value="14px">14px</option>
                            <option value="16px">16px</option>
                            <option value="18px">18px</option>
                        </select>
                    </div>
                    <div id="viewModeWrapper" class="view-mode-wrapper">
                        <label for="viewModeSelect">Режим отображения:</label>
                        <select id="viewModeSelect" onchange="updateTableView()">
                            <option value="original" selected>Показать исходные</option>
                            <option value="tokenized" disabled>Показать токенизированные</option>
                            <option value="both" disabled>Показать оба</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <div class="table-scroll-top" id="tableScrollTop"></div>
                <div class="table-container-wrapper">
                    <div class="table-anchor-gutter" id="tableAnchorGutter"></div>
                    <div class="table-container" id="tableContainer">
                        <table id="dataTable"></table>
                    </div>
                </div>
            </div>
            
            <div class="download-section" id="downloadSection" style="display: none; margin-top: 20px;">
                <h3>Экспорт</h3>
                <div class="download-buttons">
                    <button class="download-button-data" onclick="downloadCSV()">Скачать CSV</button>
                    <button class="download-button-data" onclick="downloadXLSX()">Скачать XLSX</button>
                    <button class="download-button-dict" onclick="downloadJSON()">Скачать JSON-словарь</button>
                    <button class="download-button-zip" onclick="downloadBundleZip()">Скачать комплект в ZIP</button>
                </div>
            </div>
        </div>

        <!-- Промпт для нейросети -->
        <div class="section" id="promptStandaloneSection">
            <div class="collapsible-header prompt-header">
                <h2>Промпт для нейросети</h2>
                <div class="collapsible-actions prompt-actions-inline">
                    <button class="prompt-toggle-button" onclick="togglePromptSection(this)">Развернуть</button>
                    <button class="copy-button copy-button-prompt" onclick="copyPromptText(this)">Копировать</button>
                    <span class="help-icon" data-tooltip="Вставьте текст в конец запроса в режиме «Промпт для нейросети», чтобы модель не меняла токены [[...]]: не править, не разрывать, не расшифровывать.">?</span>
                </div>
            </div>
            <div class="prompt-section" id="promptSection" style="display: none;">
                <div class="prompt-card">
                    <div class="prompt-text" id="promptTextarea">В прилагаемой таблице встречаются токены вида [[...]]. Это псевдоанонимизированные значения: они заменяют исходные данные и расшифровываются только по отдельному JSON-словарю соответствий.
Жёсткое правило: не изменяй токены [[...]] ни при каких условиях.

(1) Токен — это подстрока от [[ до ]] целиком. Запрещено разрывать токен переносом строки или вставлять внутрь токена пробелы/переносы.
(2) Не меняй внутри токена ни одного символа: буквы/цифры/знаки, регистр, длину.
(3) Не добавляй и не удаляй символы внутри токена. Не разбивай токен на части и не объединяй токены между собой.
(4) Не пытайся расшифровать токены и не придумывай исходные значения.
(5) Запрещено создавать новые токены вида [[...]]. Используй только те токены, которые даны во входных данных.
(6) Если нужно сослаться на значение — используй токен ровно как он дан, целиком, включая [[ и ]]. Если токен встречается несколько раз — считай, что это одно и то же значение.
(7) Если в ответе используются токены — выводи ответ простым текстом (без Markdown-таблиц, код-блоков и ссылок), чтобы не исказить токены.
(8) Перед отправкой ответа проверь, что каждый токен в твоём ответе совпадает с токеном из входных данных символ-в-символ.</div>
                </div>
            </div>
        </div>

        <!-- Детокенизация -->
        <div class="section" id="detokenizationSection">
            <h2>Детокенизация</h2>
            
            <div class="json-import-section">
                <div class="json-import-control-top">
                    <label for="jsonInput">Импорт JSON-словаря:</label>
                    <input type="file" id="jsonInput" accept=".json" />
                    <span id="jsonFileName" class="json-file-name"></span>
                </div>
                <hr class="section-divider">
            </div>
            
            <div class="detokenization-layout">
                <div class="detokenization-left">
                    <label for="responseTextarea">Ответ нейросети (сырой):</label>
                    <div class="textarea-wrapper">
                        <pre class="textarea-highlight" id="responseHighlight" aria-hidden="true"></pre>
                        <textarea id="responseTextarea" placeholder="Вставьте текст с токенами [[...]]"></textarea>
                    </div>
                </div>
                
                <div class="detokenization-center">
                    <h4>Статистика</h4>
                    <div class="detokenization-stats">
                        <div class="stats-summary" id="statsSummary"></div>
                    </div>
                </div>
                
                <div class="detokenization-right">
                    <div class="tokens-header">
                        <h4>Найденные токены</h4>
                        <div class="token-filters">
                            <label class="token-filter-checkbox token-filter-found" title="Показать распознанные">
                                <input type="checkbox" checked onchange="toggleTokenFilter('found', this)">
                                <span></span>
                            </label>
                            <label class="token-filter-checkbox token-filter-notfound" title="Показать нераспознанные">
                                <input type="checkbox" checked onchange="toggleTokenFilter('notFound', this)">
                                <span></span>
                            </label>
                        </div>
                    </div>
                    <div class="tokens-list-container">
                        <div id="tokensList"></div>
                    </div>
                </div>
            </div>

            <div class="detokenized-result">
                <div class="result-header">
                    <h3>Ответ (детокенизированный)</h3>
                    <button class="prompt-toggle-button result-toggle-button" onclick="toggleDetokenizedResult(this)">Развернуть</button>
                    <button class="copy-button copy-button-result" onclick="copyDetokenizedText(this)">Копировать</button>
                </div>
                <div id="detokenizedText" class="result-text result-text-collapsed"></div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения очистки -->
    <div class="modal-overlay" id="clearModal">
        <div class="modal-dialog">
            <h3>Подтвердите действие</h3>
            <div id="clearModalWarning" class="warning" style="display: none;">
                <strong>Внимание!</strong> Вы экспортировали таблицу, но не экспортировали JSON-словарь. 
                Без словаря детокенизация будет невозможна. Убедитесь, что вы сохранили словарь перед очисткой.
            </div>
            <p id="clearModalMessage">Вы уверены, что хотите очистить все данные?</p>
            <div class="modal-buttons">
                <button class="modal-button modal-button-cancel" onclick="closeClearModal()">Отмена</button>
                <button class="modal-button modal-button-confirm" onclick="confirmClear()">Очистить</button>
            </div>
        </div>
    </div>

    <script src="xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
