<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Псевдоанонимизация Excel-таблиц v0.1</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Псевдоанонимизация Excel-таблиц v0.1</h1>
        
        <!-- Загрузка файла и управление -->
        <div class="section">
            <h2>Загрузка файла</h2>
            <div class="file-controls-row">
                <div class="file-control-item">
                    <label for="fileInput">Выбор файла XLSX:</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <div class="file-control-item" id="sheetSelectionWrapper">
                    <label for="sheetSelect">Лист:</label>
                    <select id="sheetSelect"></select>
                </div>
                <div class="file-control-item">
                    <button id="recognizeButton" onclick="recognizeData()" style="display: none;">Распознать данные</button>
                </div>
                <div class="file-control-item file-control-item-clear">
                    <button id="clearButton" onclick="clearAll()" style="display: none;">Очистить</button>
                </div>
            </div>
        </div>

        <!-- Таблица -->
        <div class="section" id="tableSection" style="display: none;">
            <h2>Таблица</h2>
            <div class="table-controls-row">
                <div class="table-controls-left">
                    <button onclick="tokenizeColumns()">Токенизировать выбранные столбцы</button>
                </div>
                <div class="table-controls-right">
                    <div id="fontSizeWrapper" style="display: none;" class="view-mode-wrapper">
                        <label for="fontSizeSelect">Размер текста в таблице:</label>
                        <select id="fontSizeSelect" onchange="updateTableFontSize()">
                            <option value="10px">10px</option>
                            <option value="12px" selected>12px</option>
                            <option value="14px">14px</option>
                            <option value="16px">16px</option>
                            <option value="18px">18px</option>
                        </select>
                    </div>
                    <div id="viewModeWrapper" style="display: none;" class="view-mode-wrapper">
                        <label for="viewModeSelect">Режим отображения:</label>
                        <select id="viewModeSelect" onchange="updateTableView()">
                            <option value="tokenized">Показать токенизированные</option>
                            <option value="original">Показать исходные</option>
                            <option value="both">Показать оба</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <div class="table-scroll-top" id="tableScrollTop"></div>
                <div class="table-container-wrapper">
                    <div class="table-anchor-gutter" id="tableAnchorGutter"></div>
                    <div class="table-container" id="tableContainer">
                        <table id="dataTable"></table>
                    </div>
                </div>
            </div>
            
            <div class="download-section" id="downloadSection" style="display: none; margin-top: 20px;">
                <h3>Экспорт</h3>
                <div class="download-buttons">
                    <button class="download-button-data" onclick="downloadCSV()">Скачать CSV</button>
                    <button class="download-button-data" onclick="downloadXLSX()">Скачать XLSX</button>
                    <button class="download-button-dict" onclick="downloadJSON()">Скачать JSON-словарь</button>
                </div>
                <div class="prompt-subsection">
                    <div class="prompt-subsection-header">
                        <h4>Промпт для нейросети</h4>
                        <div class="prompt-header-buttons">
                            <button class="copy-button copy-button-prompt" onclick="copyPromptText(this)">Копировать</button>
                            <button class="prompt-toggle-button" onclick="togglePromptSection(this)">▶</button>
                        </div>
                    </div>
                    <div class="prompt-section" id="promptSection" style="display: none;">
                        <div class="prompt-card">
                            <div class="prompt-text" id="promptTextarea">В таблице ниже встречаются токены вида [[...]]. Это псевдоанонимизированные значения: они заменяют исходные данные и расшифровываются только по отдельному JSON-словарю соответствий.
Жёсткое правило: не изменяй токены [[...]] ни при каких условиях.

(1) Токен — это подстрока от [[ до ]] целиком. Запрещено разрывать токен переносом строки или вставлять внутрь токена пробелы/переносы.
(2) Не меняй внутри токена ни одного символа: буквы/цифры/знаки, регистр, длину.
(3) Не добавляй и не удаляй символы внутри токена. Не разбивай токен на части и не объединяй токены между собой.
(4) Не пытайся расшифровать токены и не придумывай исходные значения.
(5) Запрещено создавать новые токены вида [[...]]. Используй только те токены, которые даны во входных данных.
(6) Если нужно сослаться на значение — используй токен ровно как он дан, целиком, включая [[ и ]]. Если токен встречается несколько раз — считай, что это одно и то же значение.
(7) Если в ответе используются токены — выводи ответ простым текстом (без Markdown-таблиц, код-блоков и ссылок), чтобы не исказить токены.
(8) Перед отправкой ответа проверь, что каждый токен в твоём ответе совпадает с токеном из входных данных символ-в-символ.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Детокенизация -->
        <div class="section" id="detokenizationSection">
            <h2>Детокенизация</h2>
            
            <div class="json-import-section">
                <hr class="section-divider">
                <div class="json-import-control-top">
                    <label for="jsonInput">Импорт JSON-словаря:</label>
                    <input type="file" id="jsonInput" accept=".json" />
                    <span id="jsonFileName" class="json-file-name"></span>
                </div>
                <hr class="section-divider">
            </div>
            
            <div class="detokenization-layout">
                <div class="detokenization-left">
                    <label for="responseTextarea">Ответ нейросети (сырой):</label>
                    <textarea id="responseTextarea" placeholder="Вставьте текст с токенами [[...]]"></textarea>
                </div>
                
                <div class="detokenization-center">
                    <h4>Статистика</h4>
                    <div class="detokenization-stats">
                        <div class="stats-summary" id="statsSummary"></div>
                    </div>
                </div>
                
                <div class="detokenization-right">
                    <h4>Найденные токены</h4>
                    <div class="tokens-list-container">
                        <div id="tokensList"></div>
                    </div>
                </div>
            </div>

            <div class="detokenized-result">
                <div class="result-header">
                    <h3>Ответ (детокенизированный)</h3>
                    <button class="copy-button copy-button-result" onclick="copyDetokenizedText(this)">Копировать</button>
                </div>
                <div id="detokenizedText" class="result-text"></div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения очистки -->
    <div class="modal-overlay" id="clearModal">
        <div class="modal-dialog">
            <h3>Подтвердите действие</h3>
            <div id="clearModalWarning" class="warning" style="display: none;">
                <strong>Внимание!</strong> Вы экспортировали таблицу, но не экспортировали JSON-словарь. 
                Без словаря детокенизация будет невозможна. Убедитесь, что вы сохранили словарь перед очисткой.
            </div>
            <p id="clearModalMessage">Вы уверены, что хотите очистить все данные?</p>
            <div class="modal-buttons">
                <button class="modal-button modal-button-cancel" onclick="closeClearModal()">Отмена</button>
                <button class="modal-button modal-button-confirm" onclick="confirmClear()">Очистить</button>
            </div>
        </div>
    </div>

    <script src="xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
