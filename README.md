# Псевдоанонимизация Excel-таблиц

Локальный веб-сервис для токенизации (псевдоанонимизации) данных из Excel/CSV-файлов. Все операции выполняются **строго в браузере клиента**, без отправки данных на сервер.

---

## Содержание

1. [Назначение](#назначение)
2. [Ключевые возможности](#ключевые-возможности)
3. [Как это работает](#как-это-работает)
4. [Принцип токенизации](#принцип-токенизации)
5. [Детокенизация](#детокенизация)
6. [Безопасность и приватность](#безопасность-и-приватность)
7. [Требования и запуск](#требования-и-запуск)
8. [Экспортируемые файлы](#экспортируемые-файлы)
9. [Ограничения](#ограничения)
10. [Частые вопросы (FAQ)](#частые-вопросы-faq)
11. [Лицензия](#лицензия)

---

## Назначение

Сервис предназначен для псевдоанонимизации персональных и конфиденциальных данных в таблицах перед их отправкой на обработку нейросетями или другими внешними сервисами.

### Для каких задач используется

- **Защита персональных данных** при анализе таблиц с помощью ИИ
- **Конфиденциальность** при передаче данных третьим лицам
- **Соответствие требованиям** по обработке персональных данных (GDPR, 152-ФЗ и др.)
- **Безопасная обработка** данных без раскрытия исходных значений

### Примеры сценариев

- Анализ медицинских данных: токенизация ФИО, адресов, номеров документов перед отправкой на анализ
- Обработка финансовых данных: замена идентификаторов клиентов, счетов, транзакций
- Исследование данных: анонимизация участников исследования перед публикацией или передачей

---

## Ключевые возможности

### Импорт данных

- **Поддержка форматов**: XLSX, XLS
- **Выбор листа**: при наличии нескольких листов в файле можно выбрать нужный
- **Автоматическое распознавание**: структура таблицы определяется автоматически

### Управление токенизацией

- **Выбор столбцов**: можно выбрать несколько столбцов для токенизации одновременно
- **Маркер начала токенизации**: возможность указать строку, с которой начинается токенизация (строки выше маркера остаются без изменений)
- **Визуальная индикация**: 
  - Жёлтый цвет — выбранные для токенизации столбцы
  - Зелёный цвет — уже токенизированные столбцы

### Режимы отображения

- **Исходные данные**: отображение оригинальных значений
- **Токенизированные данные**: отображение токенов вместо исходных значений
- **Оба режима**: одновременное отображение исходных и токенизированных значений

### Экспорт результатов

- **Токенизированная таблица**: экспорт в форматах CSV или XLSX
- **JSON-словарь**: экспорт словаря соответствий токенов и исходных значений
- **Синхронизированные имена файлов**: таблица и словарь получают одинаковый префикс (ID экспорта) для удобной сопоставления

### Детокенизация ответов

- **Импорт JSON-словаря**: загрузка сохранённого словаря
- **Обработка текста**: автоматическое распознавание токенов в тексте ответа нейросети
- **Восстановление данных**: замена токенов на исходные значения согласно словарю
- **Статистика**: информация о количестве найденных и распознанных токенов

---

## Как это работает

### Высокоуровневая схема процесса

1. **Загрузка таблицы**
   - Пользователь выбирает файл XLSX/XLS
   - Приложение загружает файл в память браузера
   - Если в файле несколько листов, пользователь выбирает нужный

2. **Выбор столбцов**
   - Пользователь отмечает чекбоксами столбцы, которые нужно токенизировать
   - Можно выбрать несколько столбцов одновременно
   - При необходимости устанавливается маркер начала токенизации (строки выше маркера не токенизируются)

3. **Токенизация**
   - Для каждого уникального значения в выбранных столбцах генерируется уникальный токен
   - Одинаковые значения получают одинаковый токен
   - Токены заменяют исходные значения в выбранных столбцах
   - Создаётся словарь соответствий: токен → исходное значение

4. **Экспорт таблицы и словаря**
   - Экспорт токенизированной таблицы в CSV или XLSX
   - Экспорт JSON-словаря с соответствиями
   - Оба файла получают одинаковый префикс в имени для сопоставления

5. **Вставка ответа нейросети**
   - Пользователь отправляет токенизированную таблицу на обработку нейросетью
   - Получает ответ, содержащий токены вида `[[...]]`

6. **Импорт словаря**
   - Пользователь загружает сохранённый JSON-словарь в раздел детокенизации

7. **Детокенизация**
   - Приложение находит все токены в тексте ответа
   - Заменяет токены на исходные значения из словаря
   - Выводит восстановленный текст

---

## Принцип токенизации

### Что такое токенизация

Токенизация — это процесс замены исходных значений данных на токены (случайные идентификаторы). Токены не несут никакого смысла и не связаны с исходными данными вычислимым образом.

### Как генерируются токены

1. **Криптографическая случайность**: токены генерируются с использованием `crypto.getRandomValues()` — криптографически стойкого генератора случайных чисел браузера
2. **Формат токена**: 
   - Генерируется 16 байт случайных данных
   - Конвертируются в base64url (безопасный для использования в тексте вариант base64)
   - Оборачиваются в двойные квадратные скобки: `[[base64url-строка]]`
   - Пример: `[[aB3dEf9gH1jK2lM3nO4pQ]]`

### Правила токенизации

- **Один исходный текст → один токен**: одинаковые значения в рамках одной сессии токенизации получают одинаковый токен
- **Уникальность**: разные значения получают разные токены
- **Необратимость**: по токену невозможно восстановить исходное значение без словаря
- **Отсутствие паттернов**: токены не содержат префиксов, суффиксов или других признаков, указывающих на тип данных

### Что хранится в словаре

Словарь соответствий хранит пары:
- **Ключ**: токен (например, `[[aB3dEf9gH1jK2lM3nO4pQ]]`)
- **Значение**: исходное значение (например, `Иванов Иван Иванович`)

Формат JSON-словаря:
```json
{
  "[[aB3dEf9gH1jK2lM3nO4pQ]]": "Иванов Иван Иванович",
  "[[xY7zAb2cD4eF6gH8iJ0kL]]": "+7 (999) 123-45-67"
}
```

### Что означает токен в данных

Токен — это **маркер/идентификатор**, который:
- Не несёт исходного смысла
- Не является сокращением или шифром исходного текста
- Представляет собой случайную строку, связанную с исходным значением только через словарь
- Используется как атомарное значение, которое нельзя изменять, разбивать или склеивать

---

## Детокенизация

### Процесс детокенизации

1. **Импорт JSON-словаря**
   - Нажмите "Выбор файла" в разделе "Импорт JSON-словаря"
   - Выберите сохранённый файл словаря (формат `.json`)
   - Словарь загружается в память приложения

2. **Вставка ответа нейросети**
   - Вставьте текст ответа нейросети в поле "Ответ нейросети (сырой)"
   - Текст может содержать токены вида `[[...]]`

3. **Автоматическая обработка**
   - Приложение автоматически находит все токены в тексте
   - Для каждого токена проверяется наличие в словаре
   - Токены заменяются на исходные значения

4. **Результат**
   - В разделе "Ответ (детокенизированный)" отображается восстановленный текст
   - Найденные токены подсвечиваются в списке справа
   - Отображается статистика: количество найденных и распознанных токенов

### Важные правила работы с токенами

⚠️ **Критически важно**: токены нельзя изменять ни при каких условиях!

1. **Не изменяйте токены**: нельзя менять символы внутри токена, регистр, длину
2. **Не разрывайте токены**: токен `[[...]]` должен оставаться целым, нельзя вставлять пробелы или переносы строк
3. **Не удаляйте символы**: нельзя удалять `[[`, `]]` или символы между ними
4. **Не создавайте новые токены**: нельзя создавать токены вида `[[...]]` вручную
5. **Используйте токены целиком**: если токен встречается в тексте, используйте его полностью, как он дан

**Почему это важно**: любое изменение токена приведёт к тому, что он не будет найден в словаре, и детокенизация не произойдёт.

---

## Безопасность и приватность

### Обработка данных выполняется локально

**Все операции выполняются строго в браузере клиента.** Данные не отправляются на сервер и не передаются через сеть.

- ✅ Обработка файлов происходит локально в памяти браузера
- ✅ Токенизация выполняется на стороне клиента
- ✅ Детокенизация выполняется на стороне клиента
- ✅ Сервис не использует внешние API
- ✅ Сервис не делает сетевые запросы для обработки данных

### Где хранятся данные

**Данные хранятся только в памяти браузера** во время работы с приложением:

- Загруженные файлы обрабатываются в памяти (объект `AppState`)
- Словари токенизации хранятся в памяти (Map-структуры)
- Данные не сохраняются в localStorage, sessionStorage или других механизмах хранения браузера
- При закрытии вкладки или перезагрузке страницы все данные удаляются

**Важно**: для сохранения результатов необходимо экспортировать таблицу и словарь в файлы.

### Почему токены нельзя расшифровать без словаря

Токены **практически невозможно восстановить** без словаря по следующим причинам:

1. **Криптографическая случайность**: токены генерируются с использованием криптографически стойкого генератора случайных чисел (`crypto.getRandomValues()`)
2. **Отсутствие вычислимой связи**: между токеном и исходным значением нет математической или алгоритмической связи
3. **Достаточная длина**: токены имеют достаточную длину (128 бит энтропии), что делает перебор практически невозможным
4. **Отсутствие паттернов**: токены не содержат префиксов, суффиксов или других признаков, которые могли бы указать на тип или значение данных

**Вывод**: восстановление исходных данных из токенов возможно **только** при наличии JSON-словаря соответствий.

### Риски и ограничения

#### Безопасность словаря

⚠️ **Словарь — ключевой элемент безопасности.**

- Если словарь утечёт вместе с токенизированной таблицей, возможна полная расшифровка данных
- **Рекомендации**:
  - Храните словарь отдельно от токенизированной таблицы
  - Передавайте словарь только доверенным лицам
  - Не отправляйте словарь вместе с таблицей на обработку
  - Используйте надёжные методы хранения словаря (шифрование, защищённое хранилище)

#### Токенизация ≠ необратимое шифрование

- Токенизация — это **псевдоанонимизация**, а не необратимое шифрование
- При наличии словаря данные полностью восстанавливаются
- Это защищает данные только при отсутствии словаря у третьих лиц

#### Ограничения браузера

- Производительность зависит от объёма данных и возможностей браузера
- Очень большие файлы могут обрабатываться медленно или вызывать проблемы с памятью
- Рекомендуется работать с файлами размером до нескольких десятков мегабайт

### Рекомендации по безопасности

1. **Храните словарь отдельно**: не отправляйте словарь вместе с токенизированной таблицей
2. **Ограничьте доступ к словарю**: передавайте словарь только тем, кому необходимо выполнить детокенизацию
3. **Используйте надёжные методы хранения**: при необходимости зашифруйте словарь перед хранением
4. **Удаляйте словарь после использования**: если детокенизация больше не требуется, безопасно удалите словарь
5. **Проверяйте целостность токенов**: убедитесь, что токены в ответе нейросети не были изменены

---

## Требования и запуск

### Требования

- **Браузер**: современный браузер с поддержкой:
  - JavaScript ES6+
  - Web Crypto API (`crypto.getRandomValues`)
  - FileReader API
  - Blob API
- **Файлы проекта**:
  - `index.html` — основной файл интерфейса
  - `app.js` — логика приложения
  - `styles.css` — стили
  - `xlsx.full.min.js` — библиотека для работы с Excel (включена в проект)

### Запуск

#### Вариант 1: Прямое открытие файла

1. Скачайте или клонируйте репозиторий
2. Откройте файл `index.html` в браузере (двойной клик или через меню "Открыть файл")
3. Приложение готово к работе

#### Вариант 2: Через локальный веб-сервер (опционально)

Для некоторых браузеров может потребоваться локальный сервер из-за политики CORS:

```bash
# Python 3
python -m http.server 8000

# Node.js (http-server)
npx http-server

# PHP
php -S localhost:8000
```

Затем откройте в браузере: `http://localhost:8000`

**Примечание**: для большинства современных браузеров вариант 1 работает без проблем.

---

## Экспортируемые файлы

### Токенизированная таблица

**Форматы**: CSV, XLSX

**Содержимое**:
- Столбцы, выбранные для токенизации, содержат токены вместо исходных значений
- Столбцы, не выбранные для токенизации, остаются без изменений
- Строки выше маркера токенизации остаются без изменений

**Имя файла**: `{ID}_Таблица_{дата}_{время}.{расширение}`
- Пример: `aB3dEf9g_Таблица_20260103_1430.csv`

### JSON-словарь

**Формат**: JSON

**Содержимое**: объект, где ключи — токены, значения — исходные данные
```json
{
  "[[aB3dEf9gH1jK2lM3nO4pQ]]": "Иванов Иван Иванович",
  "[[xY7zAb2cD4eF6gH8iJ0kL]]": "+7 (999) 123-45-67"
}
```

**Имя файла**: `{ID}_Словарь_{дата}_{время}.json`
- Пример: `aB3dEf9g_Словарь_20260103_1430.json`

**Важно**: ID экспорта одинаковый для таблицы и словаря, что позволяет легко сопоставить их.

### Как правильно хранить пару "таблица + словарь"

1. **Храните файлы вместе**: поместите таблицу и словарь в одну папку
2. **Используйте одинаковые имена**: ID в имени файла позволяет легко найти соответствующий словарь
3. **Создайте резервные копии**: особенно важно для словаря
4. **Документируйте**: при необходимости создайте текстовый файл с описанием, какие столбцы были токенизированы

---

## Ограничения

### Максимальные размеры

Ограничения зависят от возможностей браузера и объёма оперативной памяти:

- **Рекомендуемый размер файла**: до 10-50 МБ
- **Количество строк**: зависит от браузера, обычно до нескольких десятков тысяч строк
- **Количество столбцов**: практически не ограничено
- **Размер словаря**: зависит от количества уникальных значений

**Примечание**: при работе с очень большими файлами браузер может работать медленно или зависнуть. В таких случаях рекомендуется разбить файл на части.

### Особенности Excel

#### Поддерживается

- ✅ Чтение данных из ячеек
- ✅ Экспорт в XLSX с сохранением структуры таблицы
- ✅ Выбор листа из многостраничной книги
- ✅ Экспорт в CSV с корректной кодировкой (UTF-8 с BOM)

#### Не поддерживается

- ❌ Формулы: при импорте вычисляются только значения, формулы не сохраняются
- ❌ Объединённые ячейки: объединённые ячейки обрабатываются как отдельные
- ❌ Форматирование: цвет, шрифты, стили не сохраняются
- ❌ Графики и диаграммы: не импортируются и не экспортируются
- ❌ Многострочный текст в ячейках: обрабатывается, но форматирование может быть утеряно

**Рекомендация**: для работы с формулами и сложным форматированием используйте оригинальный файл, а токенизированную версию — только для передачи данных.

---

## Частые вопросы (FAQ)

### Можно ли восстановить данные без словаря?

**Нет, практически невозможно.** Токены генерируются криптографически случайно и не содержат информации об исходных данных. Без словаря соответствий восстановление данных невозможно.

### Можно ли токенизировать только часть строк?

**Да.** В приложении есть маркер начала токенизации. Строки выше маркера остаются без изменений, токенизируются только строки начиная с маркера. Это полезно, если заголовки или первые строки должны остаться в исходном виде.

### Что делать, если потерял словарь?

**К сожалению, восстановление невозможно.** Без словаря соответствий токены не могут быть расшифрованы. Это принципиальное ограничение системы безопасности.

**Рекомендации**:
- Всегда создавайте резервные копии словаря
- Храните словарь в надёжном месте
- Используйте систему контроля версий для словарей (если это допустимо)

### Можно ли использовать один словарь для нескольких файлов?

**Технически возможно, но не рекомендуется.** 

- Каждая сессия токенизации создаёт свой словарь
- Если один и тот же исходный текст встречается в разных файлах, он получит разные токены в разных словарях
- Использование словаря от другой сессии может привести к неправильной детокенизации

**Рекомендация**: для каждого токенизированного файла используйте соответствующий ему словарь.

### Можно ли токенизировать один и тот же файл несколько раз?

**Да, но каждый раз будет создан новый словарь.** Даже если исходные данные одинаковые, токены будут разными в каждой сессии. Это обеспечивает дополнительную безопасность.

### Что происходит с пустыми ячейками?

Пустые ячейки не токенизируются и остаются пустыми в экспортируемой таблице.

### Можно ли отменить токенизацию столбца?

**Да.** Если снять галочку с уже токенизированного столбца, токенизация будет отменена, и столбец вернётся к исходным значениям. Однако это работает только в рамках текущей сессии — если файл был экспортирован, отменить токенизацию в экспортированном файле нельзя.

### Поддерживается ли импорт CSV?

**Нет, в текущей версии поддерживается только импорт XLSX/XLS.** Для работы с CSV-файлами рекомендуется сначала конвертировать их в XLSX.

### Можно ли токенизировать несколько столбцов одновременно?

**Да.** Можно выбрать несколько столбцов чекбоксами и токенизировать их одной кнопкой. Каждый столбец обрабатывается независимо, но одинаковые значения в разных столбцах получат одинаковые токены.

### Что делать, если нейросеть изменила токены в ответе?

Если токены были изменены (символы заменены, удалены, добавлены пробелы), они не будут распознаны словарём. В этом случае:

1. Проверьте, что токены в ответе точно соответствуют токенам в исходной таблице
2. Убедитесь, что используется правильный словарь
3. Если токены были изменены нейросетью, восстановление невозможно — необходимо запросить новый ответ с сохранением токенов

---

## Лицензия

Лицензия не задана.

---

## Техническая информация

### Используемые технологии

- **HTML5**: структура интерфейса
- **CSS3**: стилизация
- **JavaScript (ES6+)**: логика приложения
- **SheetJS (xlsx.full.min.js)**: работа с Excel-файлами
- **Web Crypto API**: генерация криптографически стойких токенов

### Версия

v0.1

---

**Важно**: этот сервис предназначен для локального использования. Все данные обрабатываются в браузере и не передаются на сервер. Словарь соответствий — единственный способ восстановления данных, храните его в безопасности.
